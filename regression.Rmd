---
title: "Regression"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages
```{r}
library(tidyverse)
library(segmented)
```

## Load data
```{r}
ontario <- read_csv('Estimated_R/ontario_R.csv')
peel <- read_csv('Estimated_R/peel_R.csv')
toronto <- read_csv('Estimated_R/tor_R.csv')
waterloo <- read_csv('Estimated_R/wat_R.csv')
york <- read_csv('Estimated_R/york_R.csv')
```

## Function
```{r}
segmented_regressions <- function(data, name, breaks=NULL) {

  # make linear regression for entire data
  my.lm <- lm(`Mean(R)` ~ date_start, data = data)
  # make segmented regression
  if (is.null(breaks)) {
    my.seg <- segmented(my.lm,
                        seg.Z = ~ date_start)
    breaks <- my.seg$psi[, 2]
  } else {
    my.seg <- segmented(my.lm,
                        seg.Z = ~ date_start,
                        fixed.psi = list(date_start=breaks))
  }
  
  # get the fitted data
  my.fitted <- fitted(my.seg)
  my.model <- data.frame(date_start = data$date_start, 
                         Mean_R = my.fitted)
  # plot the fitted model
  p <- ggplot(data, aes(x = date_start, y = `Mean(R)`)) +
    geom_line() +
    geom_line(my.model, 
              mapping=aes(x = date_start, y = Mean_R),
              color='red') +
    geom_vline(xintercept = breaks, linetype = "dashed") +
    labs(title=name)
  
  return(list(my.seg=my.seg, plot=p, breaks=breaks))
}
```

```{r}
regression_eqs <- function(data, my.seg, breaks) {
  # get slopes of segments
  slopes <- slope(my.seg)
  # get intercepts of segments
  intercepts <- intercept(my.seg)
  # get first date in data
  first <- first(data$date_start)
  # get last date
  last <- last(data$date_start)
  # get mystery break point and find difference between first date
  x <- my.seg$psi[, 2] - as.numeric(first, 'yyyy-mm-dd')
  # add to first date to get mystery date object
  calc <- first + round(x)
  # create new dates vector
  new_dates <- c(first, last, calc)
  # append to known dates and sort
  if(!is.numeric(breaks)){
    segs <- sort(append(breaks, new_dates))
  } else {
    segs <- sort(new_dates)
  }
  
  # create data frame of all the info
  df <- data.frame(break_start=segs[1:length(segs)-1],
                   break_end=segs[-1],
                   slope=slopes$date_start[,1],
                   intercept=intercepts$date_start[,1])
  return(df)
}
```

## Ontario
Data starts on 3/4/20
Date	Milestone  
<!-- 3/17/20	Emergency declared   -->
3/23/20	Closure of all non essential business  
<!-- 4/14/20	Extended state of Emergency for further 4 weeks   -->
<!-- 5/6/20	Emergency extended again upto 19/05/20  -->
5/14/20	Phase2 :Restart. Guidelines issued  
<!-- 5/27/20	Extended Emergency order till June 9,2020   -->
<!-- 6/2/20	Extended Emergency order for 28 days   -->
6/8/20	Stage 2of recovery Plan in some regions announced  
<!-- 7/9/20	Extended Emergency order till July 22,2020   -->
7/13/20	Stage 3 of recovery Plan in some regions announced from 17/07/20  
<!-- 8/20/20	Extended Emergency order till Sept 22,2020   -->
9/28/20	Enters Stage 2/ Second Wave of Pandemic official announcement  
12/14/20	Orange  
12/26/20	Grey  

```{r}
# get list of break points
dates <-  as.Date(c('2020-03-23', '2020-05-14', '2020-06-08', '2020-07-13', '2020-09-28', '2020-12-14', '2020-12-26'))

res <- segmented_regressions(ontario, 'Ontario fixed breaks', dates)
df <- regression_eqs(ontario, res$my.seg, res$breaks)
res$plot
df
```

```{r}
res <- segmented_regressions(ontario, 'Ontario default breaks')
df <- regression_eqs(ontario, res$my.seg, res$breaks)
res$plot
df
```

## Peel
Data starts on 3/12/20
Date	Milestone  
<!-- 3/5/20	First Confirmed Case   -->
3/26/20	State of Emergency declared  
6/22/20	Enters to Stage 2  
7/29/20	Enters to Stage 3  
10/11/20	“modified” version of Stage 2  
11/7/20	Orange  
<!-- 11/9/20	Red   -->
12/14/20	Grey  
```{r}
dates <- as.Date(c('2020-03-26', '2020-06-22', '2020-07-29', '2020-10-11', '2020-11-07', '2020-12-14'))

res <- segmented_regressions(peel, 'Peel fixed breaks', dates)
df <- regression_eqs(peel, res$my.seg, res$breaks)
res$plot
df
```

```{r}
res <- segmented_regressions(peel, 'Peel default breaks')
df <- regression_eqs(peel, res$my.seg, res$breaks)
res$plot
df
```

## Toronto
Data starts on 3/4/20
Date	Milestone  
<!-- 3/17/20	State of Emergency declared   -->
3/23/20	City hall and civic centres closed  
6/24/20	enters Stage 2  
11/14/20	Orange  
<!-- 11/20/20	Red   -->
12/14/20	Grey  
```{r}
dates <- as.Date(c('2020-03-23', '2020-06-24', '2020-11-14',  '2020-12-14'))

res <- segmented_regressions(toronto, 'Toronto fixed breaks', dates)
df <- regression_eqs(toronto, res$my.seg, res$breaks)
res$plot
df
```

```{r}
res <- segmented_regressions(toronto, 'Toronto default breaks')
df <- regression_eqs(toronto, res$my.seg, res$breaks)
res$plot
df
```

## Waterloo
Data starts 3/11/20
Date	Milestone  
<!-- 3/3/20	Region's first Case   -->
<!-- 3/17/20	State of Emergency declared   -->
3/25/20	Region's municipalities declare their own State of Emergency  
6/12/20	Move into Stage 2  
7/13/20	Move into Stage 3  
9/22/20	Moved to second wave  
11/3/20	Green  
<!-- 11/7/20	Yellow   -->
11/16/20	Orange  
<!-- 11/23/20	Red   -->
12/26/20	Grey
```{r}
dates <- as.Date(c('2020-03-25', '2020-06-12', '2020-07-13', '2020-09-22', '2020-11-03', '2020-11-16', '2020-12-26'))

res <- segmented_regressions(waterloo, 'Waterloo fixed dates', dates)
df <- regression_eqs(waterloo, res$my.seg, res$breaks)
res$plot
df
```

```{r}
res <- segmented_regressions(waterloo, 'Waterloo default dates')
df <- regression_eqs(waterloo, res$my.seg, res$breaks)
res$plot
df
```


## York
Data starts on 3/10/20
Date	Milestone  
3/17/20	State of Emergency Declared  
5/19/20	Phase2 Stage1 reopening  
6/19/20	Phase2 Stage2 reopening  
7/24/20	Stage 3 Reopening  
10/19/20	Modified Stage 2  
11/6/20	Orange Level  
<!-- 11/16/20	Red Level   -->
12/14/20	Grey Level  
```{r}
dates <- as.Date(c('2020-03-17', '2020-05-19', '2020-06-19', '2020-07-24', '2020-10-19', '2020-11-06', '2020-12-14'))

res <- segmented_regressions(york, 'York fixed dates', dates)
df <- regression_eqs(york, res$my.seg, res$breaks)
res$plot
df
```

```{r}
res <- segmented_regressions(york, 'York default dates')
df <- regression_eqs(york, res$my.seg, res$breaks)
res$plot
df
```


